<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Recuperar Contrase√±a</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="center-content">

    <div id="particles-js"></div> 

    <div class="auth-container">
        <h2>üîê Recuperaci√≥n</h2>
        <div id="msg" class="message" style="display:none;"></div>

        <form id="step1Form">
            <p style="margin-bottom:15px; color:#555;">
                Ingresa tu correo para recibir un c√≥digo de verificaci√≥n.
            </p>
            <label>Email Registrado</label>
            <input type="email" id="resetEmail" placeholder="ejemplo@correo.com" required>
            <button type="submit" class="primary-btn">Enviar C√≥digo</button>
        </form>

        <form id="step2Form" style="display:none;">
            <p style="margin-bottom:15px; color:#28a745; font-weight:bold;">
                ‚úÖ C√≥digo enviado. Revisa tu bandeja de entrada.
            </p>
            
            <label>C√≥digo OTP (6 d√≠gitos)</label>
            <input type="text" id="resetCode" class="otp-input" maxlength="6" placeholder="000000" required>
            
            <label>Nueva Contrase√±a</label>
            <input type="password" id="newPassword" placeholder="M√≠nimo 6 caracteres" required>
            
            <button type="submit" class="primary-btn">Cambiar Contrase√±a</button>
        </form>

        <a href="index.html" class="secondary-btn" style="display:block; text-align:center; margin-top:20px;">
            Volver al Inicio de Sesi√≥n
        </a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="js/effects.js"></script> 
    <script src="js/main.js"></script>
    
    <script>
        // L√ìGICA DE RECUPERACI√ìN DE CONTRASE√ëA
        const API = 'http://127.0.0.1:5000/api';
        let userIdReset = null;

        // 1. Enviar correo
        document.getElementById('step1Form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value;
            const btn = e.target.querySelector('button');
            
            btn.textContent = "Enviando...";
            btn.disabled = true;

            try {
                const res = await fetch(`${API}/auth/forgot-password`, {
                    method: 'POST', 
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({email})
                });
                const data = await res.json();
                
                // Si el backend devuelve user_id, es que encontr√≥ al usuario
                if(data.user_id) {
                    userIdReset = data.user_id;
                    document.getElementById('step1Form').style.display = 'none';
                    document.getElementById('step2Form').style.display = 'block';
                } else { 
                    alert('Si el correo existe, se ha enviado un c√≥digo. (Revisa spam)');
                    // En un sistema real, por seguridad, a veces no se avisa si fall√≥ el email para no dar pistas.
                    // Pero para tu proyecto, asumimos que si no llega user_id, no se pudo procesar.
                }
            } catch(err) {
                alert('Error de conexi√≥n con el servidor.');
            } finally {
                btn.textContent = "Enviar C√≥digo";
                btn.disabled = false;
            }
        };

        // 2. Cambiar contrase√±a
        document.getElementById('step2Form').onsubmit = async (e) => {
            e.preventDefault();
            const code = document.getElementById('resetCode').value;
            const pass = document.getElementById('newPassword').value;

            try {
                const res = await fetch(`${API}/auth/reset-password`, {
                    method: 'POST', 
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({user_id: userIdReset, code, new_password: pass})
                });
                
                if(res.ok) {
                    alert('¬°Contrase√±a actualizada con √©xito! Ahora puedes iniciar sesi√≥n.');
                    window.location.href = 'index.html';
                } else { 
                    const data = await res.json();
                    alert(data.message || 'El c√≥digo es incorrecto o ha expirado.'); 
                }
            } catch(err) {
                alert('Error al intentar cambiar la contrase√±a.');
            }
        };
    </script>
</body>
</html>