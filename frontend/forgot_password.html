<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Recuperar Contraseña</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="center-content">

    <div id="particles-js"></div> 

    <div class="auth-container">
        <h2><i class="fa-solid fa-lock" style="color:var(--primary-color);"></i> Recuperar</h2>
        <div id="msg" class="message" style="display:none;"></div>

        <form id="step1Form">
            <p style="margin-bottom:15px; color:#aaa;">Ingresa tu correo para recibir el código.</p>
            <label>Email Registrado</label>
            <input type="email" id="resetEmail" required>
            <button type="submit" class="primary-btn">Enviar Código</button>
        </form>

        <form id="step2Form" style="display:none;">
            <p style="margin-bottom:15px; color:#21ba61; font-weight:bold;">
                <i class="fa-solid fa-check-circle"></i> Código enviado (Revisa la consola/correo).
            </p>
            <label>Código OTP</label>
            <input type="text" id="resetCode" class="otp-input" maxlength="6" required>
            <label>Nueva Contraseña</label>
            <input type="password" id="newPassword" required>
            <button type="submit" class="primary-btn">Cambiar Contraseña</button>
        </form>

        <a href="index.html" class="secondary-btn" style="display:block; text-align:center; margin-top:20px; border:none;">
            Volver
        </a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="js/effects.js"></script> 
    <script src="js/main.js"></script>
    
    <script>
        const API = 'http://127.0.0.1:5000/api';
        let userIdReset = null;

        document.getElementById('step1Form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value;
            const btn = e.target.querySelector('button');
            btn.textContent = "Enviando..."; btn.disabled = true;

            try {
                const res = await fetch(`${API}/auth/forgot-password`, {
                    method: 'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({email})
                });
                const data = await res.json();
                if(data.user_id) {
                    userIdReset = data.user_id;
                    document.getElementById('step1Form').style.display = 'none';
                    document.getElementById('step2Form').style.display = 'block';
                } else { alert('Si el correo existe, se envió el código.'); }
            } catch(err) { alert('Error de conexión.'); } 
            finally { btn.textContent = "Enviar Código"; btn.disabled = false; }
        };

        document.getElementById('step2Form').onsubmit = async (e) => {
            e.preventDefault();
            const code = document.getElementById('resetCode').value;
            const pass = document.getElementById('newPassword').value;

            try {
                const res = await fetch(`${API}/auth/reset-password`, {
                    method: 'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({user_id: userIdReset, code, new_password: pass})
                });
                if(res.ok) {
                    alert('¡Contraseña cambiada!');
                    window.location.href = 'index.html';
                } else { 
                    const data = await res.json();
                    alert(data.message || 'Error'); 
                }
            } catch(err) { alert('Error de red.'); }
        };
    </script>
</body>
</html>